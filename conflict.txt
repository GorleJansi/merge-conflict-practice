This is a merged version keeping the best of both changes.

